name: Terraform CI (plan + cost + reports)

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  id-token: write        # OIDC → AWS
  contents: read
  pull-requests: write   # only needed later if you enable PR cost comments

env:
  AWS_REGION: us-east-1
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # --- Repo & AWS auth ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug repo/ref
        run: |
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "PWD=$(pwd)"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::458586358075:role/Webidentity
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      - name: Create reports directory
        run: mkdir -p reports

      - name: Show repo tree
        run: |
          echo "---- ./terraform-project ----"
          ls -la ./terraform-project

      # --- Terraform: fmt/init/validate/plan ---
      - name: Terraform fmt (check)
        working-directory: ./terraform-project
        shell: bash
        run: terraform fmt -check -recursive || true

      - name: Terraform init
        working-directory: ./terraform-project
        shell: bash
        run: terraform init -upgrade

      - name: Terraform validate (→ reports/terraform_validate.txt)
        working-directory: ./terraform-project
        shell: bash
        run: terraform validate | tee ../reports/terraform_validate.txt || true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: TFLint init & run (→ reports/tflint.txt)
        working-directory: ./terraform-project
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          tflint --init
          tflint --recursive | tee ../reports/tflint.txt || true

      - name: tfsec (→ reports/tfsec.sarif & reports/tfsec.txt)
        working-directory: ./terraform-project
        shell: bash
        run: |
          tfsec . --format sarif --out ../reports/tfsec.sarif || true
          tfsec . --no-colour | tee ../reports/tfsec.txt || true

      - name: Checkov (→ reports/checkov.sarif & reports/checkov.txt)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ./terraform-project
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: reports/checkov.txt,reports/checkov.sarif

      - name: Terraform plan (binary)
        working-directory: ./terraform-project
        shell: bash
        run: terraform plan -out=plan.tfplan -no-color
     
     
      - name: Export plan to JSON & text
        working-directory: ./terraform-project
        shell: bash
        run: |
          terraform show -json plan.tfplan > ../reports/plan.json
          terraform show -no-color plan.tfplan > ../reports/plan.tx



      # --- Infracost: simple cost breakdown (no PR comment, no diff) ---
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Infracost breakdown (→ reports/infracost-breakdown.json & .txt)
        shell: bash
        run: |
          infracost breakdown --path ./terraform-project \
            --format json --out-file reports/infracost-breakdown.json || true
          infracost output --path reports/infracost-breakdown.json \
            --format table > reports/infracost-breakdown.txt || true

      # --- Upload artifacts (plan + all reports) ---
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-and-reports
          path: |
            plan.tfplan
            reports/
          retention-days: 7
