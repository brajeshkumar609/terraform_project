name: Terraform CI (plan + cost + reports)

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  id-token: write        # OIDC → AWS
  contents: read
  pull-requests: write   # needed only if you enable PR comments

env:
  AWS_REGION: us-east-1
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug repo/ref
        run: |
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_REF=$GITHUB_REF"

      # ---------- OIDC → AWS ----------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::458586358075:role/Webidentity
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      - name: Create reports directory
        run: mkdir -p reports

      # ---------- Style & Syntax ----------
      - name: Terraform fmt (check+diff → reports/terraform_fmt.diff)
        run: |
          terraform fmt -check -diff -recursive | tee reports/terraform_fmt.diff
          test ${PIPESTATUS[0]} -eq 0 || echo "fmt differences detected (logged to reports/terraform_fmt.diff)"
        shell: bash
        # (fmt -check/-diff behavior per HashiCorp docs)  [6](https://developer.hashicorp.com/terraform/cli/commands/fmt)

      - name: Terraform init
        run: terraform init -upgrade

      - name: Terraform validate (→ reports/terraform_validate.txt)
        run: terraform validate | tee reports/terraform_validate.txt || true

      # ---------- Lint & Security (soft fail, write files) ----------
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: TFLint init & run (→ reports/tflint.txt)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          tflint --init
          tflint --recursive | tee reports/tflint.txt || true

      - name: tfsec (→ reports/tfsec.sarif & reports/tfsec.txt)
        run: |
          tfsec . --format sarif --out reports/tfsec.sarif || true
          tfsec . --no-colour | tee reports/tfsec.txt || true

      - name: Checkov (→ reports/checkov.sarif & reports/checkov.txt)
        uses: bridgecrewio/checkov-action@v12
        with:
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: reports/checkov.txt,reports/checkov.sarif
        # (Checkov action usage & outputs)  [7](https://terrateam.io/blog/terraform-security-scanning-tfsec-checkov-github-actions)

      # ---------- Terraform plan ----------
      - name: Terraform plan (binary)
        run: terraform plan -out=plan.tfplan -no-color

      - name: Export plan to JSON & text
        run: |
          terraform show -json plan.tfplan > plan.json
          terraform show -no-color plan.tfplan > plan.txt

      # ---------- Infracost (simple & fast) ----------
      # We use HCL parsing (no plan required) as recommended by the CLI docs.
      # On pushes, store a breakdown; on PRs, compute a diff vs base.
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        # (Infracost action & API key steps)  [1](https://github.com/infracost/actions)[5](https://www.infracost.io/docs/)

      # PUSH to main: capture a simple cost report (no PR comment)
      - name: Infracost breakdown (→ reports/infracost-breakdown.json & .txt)
        if: github.event_name == 'push'
        run: |
          infracost breakdown --path . \
            --format json --out-file reports/infracost-breakdown.json
          infracost output --path reports/infracost-breakdown.json \
            --format table > reports/infracost-breakdown.txt
        # (CLI breakdown/output usage)  [2](https://www.infracost.io/docs/features/cli_commands/)

      # PR only: create a baseline from base branch, then diff against the PR
      - name: Infracost baseline from base branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch --no-tags origin +${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
          git checkout ${{ github.event.pull_request.base.ref }}
          infracost breakdown --path . \
            --format json --out-file /tmp/infracost-base.json
          git checkout ${{ github.head_ref }}
        # (baseline + diff pattern used in examples)  [2](https://www.infracost.io/docs/features/cli_commands/)[8](https://kieran-lowe.github.io/gitops-2024/github_action_workflows/infracost/)

      - name: Infracost diff (→ reports/infracost-diff.json & .txt)
        if: github.event_name == 'pull_request'
        run: |
          infracost diff --path . \
            --format json \
            --compare-to /tmp/infracost-base.json \
            --out-file reports/infracost-diff.json
          infracost output --path reports/infracost-diff.json \
            --format table > reports/infracost-diff.txt
        # (CLI diff & output commands)  [2](https://www.infracost.io/docs/features/cli_commands/)

      # Optional: Post a PR comment (enable later if you want PR noise)
      - name: Infracost PR comment (optional)
        if: github.event_name == 'pull_request' && false   # flip to true when ready
        run: |
          infracost comment github \
            --path reports/infracost-diff.json \
            --repo $GITHUB_REPOSITORY \
            --github-token ${{ github.token }} \
            --pull-request ${{ github.event.pull_request.number }} \
            --behavior update
        # (comment command documented in CLI commands)  [2](https://www.infracost.io/docs/features/cli_commands/)

      # ---------- Upload artifacts ----------
      - name: Upload artifacts (plan + reports)
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-and-reports
          path: |
            plan.tfplan
            plan.json
            plan.txt
            reports/
          retention-days: 7
        # (artifact v4 guidance)  [3](https://github.com/actions/upload-artifact)[4](https://github.blog/news-insights/product-news/get-started-with-v4-of-github-actions-artifacts/)

